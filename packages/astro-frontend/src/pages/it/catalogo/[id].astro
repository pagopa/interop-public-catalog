---
import Layout from '../../../layouts/Layout.astro'
import { BootstrapItaliaIcon } from '../../../components/shared/BootstrapItaliaIcon.js'
import EServiceDetails from '../../../components/EServiceDetails/EServiceDetails.astro'
import { EServiceId } from '../../../../../models/src/brandedIds'
import { useUiTranslations } from '../../../i18n/ui.i18n'

import { getLangFromUrl } from '../../../i18n/utils.i18n'
import PageHero from '../../../components/shared/PageHero.astro'
import { useEServiceDetailsTranslations } from '../../../i18n/eservice-details.i18n.js'
import ApiShowcase from '../../../components/Homepage/ApiShowcase.astro'
import RatingSection from '../../../components/shared/RatingSection.astro'
import { EServiceDataAccessChip } from '../../../components/shared/EServiceDataAccessChip'
import { sqlService } from '../../../server/services'
import { CopyUrlButton } from '../../../components/shared/CopyUrlButton.jsx'

const currentLocale = getLangFromUrl(Astro.url.pathname)
const tUi = useUiTranslations(currentLocale)
const tEserviceDetails = useEServiceDetailsTranslations(currentLocale)
const t = useEServiceDetailsTranslations(currentLocale)

const eserviceId: EServiceId = Astro.params.id as EServiceId

const eservice = await sqlService.getEService(eserviceId)

if (!eservice) {
  return Astro.redirect('/404')
}

const eservicesCorrelated = await sqlService.searchCatalog({
  limit: 3,
  orderBy: ['recent_desc'],
  offset: 0,
  producerIds: [eservice.producer_id],
  categories: [],
})

const { results: eserviceCorrelatedList } = eservicesCorrelated
---

<Layout>
  <PageHero
    title={eservice.name}
    marginFromTitle="0"
    breadcrumbItems={[
      {
        routeKey: 'HOME',
      },
      {
        routeKey: 'ESERVICE_CATALOG',
      },
      {
        routeKey: 'ESERVICE_DETAILS',
        current: true,
      },
    ]}
  >
    <div class="d-flex flex-row align-items-center justify-content-between" slot="top-hero">
      <div>
        <EServiceDataAccessChip isOpenData={false} currentLocale={currentLocale} />
      </div>
      <CopyUrlButton currentLocale={currentLocale} />
    </div>
    <p slot="bottom-hero">
      {tEserviceDetails('producer')}: <strong><u>{eservice.tenant_name}</u></strong>
    </p>
  </PageHero>
  <EServiceDetails eservice={eservice} />
  <ApiShowcase
    title={t('featured_api.title')}
    producerId={eservice.producer_id}
    producerName={eservice.tenant_name}
    highlightedEServices={eserviceCorrelatedList}
  />
  <RatingSection />
</Layout>
