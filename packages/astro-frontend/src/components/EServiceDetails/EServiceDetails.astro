---
import { BootstrapItaliaIcon } from "../shared/BootstrapItaliaIcon.js";
import AttributeSection from "./AttributesSection/AttributeSection.astro";
import InformationContainer from "./InformationContainer.astro";
import type { EService } from "pagopa-interop-public-models";
import { PopoverIcon } from "../shared/PopoverIcon.js";
import { useEServiceDetailsTranslations } from "../../i18n/eservice-details.i18n.js";
import PageIndexNav from "../shared/PageIndexNav.astro";
import {
  getLangFromUrl,
  getRouteKeyFromCurrentRoutePattern,
} from "../../i18n/utils.i18n";
import { formatData } from "../../utils/utils";
import { links } from "../../config/constants";

export interface Props {
  eservice: EService;
}

const { eservice } = Astro.props;

const currentLocale = getLangFromUrl(Astro.url.pathname);
const t = useEServiceDetailsTranslations(currentLocale);

const creationDate = formatData(eservice.created_at.toString());
const creationDateLatestDescriptor = formatData(
  eservice.active_descriptor?.created_at.toString() ?? "",
);

const routeKey = getRouteKeyFromCurrentRoutePattern(Astro.routePattern);
---

<section class="section section-muted px-0 px-md-auto py-5">
  <div class="section-content">
    <div class="container">
      <div class="row">
        <div class="col-md-4 d-none d-md-block">
          <PageIndexNav
            headings={[
              { label: t("description_section.title"), id: "descrizione" },
              { label: t("api_details_section.title"), id: "dettagli-api" },
              {
                label: t("tech_specification_section.title"),
                id: "specifiche-tecniche",
              },
              { label: t("attributes_section.title"), id: "requisiti" },
              { label: t("documentation_section.title"), id: "documentazione" },
            ]}
            style="top: 1rem;"
            class="position-sticky"
          />
        </div>

        <div class="col-xs-12 col-md-8">
          <div class="mb-default">
            <h4 id="descrizione" class="mb-4">
              {t("description_section.title")}
            </h4>
            <p>{eservice.description}</p>
          </div>

          <div class="mb-default">
            <h4 id="dettagli-api" class="mb-4">
              {t("api_details_section.title")}
            </h4>
            <ul class="list-group list-group-horizontal-lg bg-white">
              <li class="flex-fill list-group-item bg-transparent border-0 p-3">
                <div class="py-2 px-3">
                  <div
                    class="d-flex flex-row justify-content-between align-items-center"
                  >
                    <h6 class="mb-0">
                      {t("api_details_section.api_state_label")}
                    </h6>
                    <PopoverIcon
                      title={t("stateapi.tooltip.title")}
                      content={t("stateapi.tooltip.content")}
                      iconName="it-info-circle"
                      iconColor="primary"
                      iconSize="sm"
                    />
                  </div>
                  <div class="mt-3">
                    {
                      eservice.active_descriptor?.state === "Published" && (
                        <span class="badge bg-success rounded-pill">
                          {t("api_details_section.api_state_active")}
                        </span>
                      )
                    }
                    {
                      eservice.active_descriptor?.state === "Suspended" && (
                        <span class="badge bg-danger rounded-pill">
                          {t("api_details_section.api_state_suspended")}
                        </span>
                      )
                    }
                  </div>
                </div>
              </li>
              {/* Horizontal separator for mobile/tablet */}
              <hr class="d-block d-lg-none my-3 border-2" />
              {/* Vertical separator for large screens */}
              <div class="vr d-none d-lg-block mx-2 my-3"></div>
              <li class="flex-fill list-group-item bg-transparent border-0 p-3">
                <div class="py-2 px-3">
                  <h6 class="mb-0">
                    {t("api_details_section.creation_date_label")}
                  </h6>
                  <div class="d-flex flex-row align-items-center mt-3">
                    <BootstrapItaliaIcon
                      name="it-calendar"
                      color="primary"
                      size="sm"
                    />
                    <span class="ms-2">{creationDate}</span>
                  </div>
                </div>
              </li>
              {/* Horizontal separator for mobile/tablet */}
              <hr class="d-block d-lg-none my-3 border-2" />
              {/* Vertical separator for large screens */}
              <div class="vr d-none d-lg-block mx-2 my-3"></div>
              <li class="flex-fill list-group-item bg-transparent border-0 p-3">
                <div class="py-2 px-3">
                  <h6 class="mb-0">
                    {t("api_details_section.last_update_date_label")}
                  </h6>
                  <div class="d-flex flex-row align-items-center mt-3">
                    <BootstrapItaliaIcon
                      name="it-calendar"
                      color="primary"
                      size="sm"
                    />
                    <span class="ms-2">{creationDateLatestDescriptor}</span>
                  </div>
                </div>
              </li>
            </ul>

            <ul class="list-group bg-white mt-4 px-3">
              <li class="list-group-item border-0">
                <InformationContainer
                  label={t("api_details_section.delegation_label")}
                  content={eservice.is_consumer_delegable
                    ? t("available")
                    : t("not_available")}
                  icon={{
                    iconSize: "sm",
                    iconName: "it-info-circle",
                    tooltipTitle: t(
                      "api_details_section.delegation_tooltip.title",
                    ),
                    tooltipContent: t(
                      "api_details_section.delegation_tooltip.content",
                    ),
                  }}
                />
              </li>
              <hr class="my-0 border-2" />
              <li class="list-group-item border-0">
                <InformationContainer
                  label={t("api_details_section.agreements_label")}
                  content={eservice.active_descriptor
                    ?.agreement_approval_policy === "Automatic"
                    ? t("available")
                    : t("not_available")}
                  icon={{
                    iconSize: "sm",
                    iconName: "it-info-circle",
                    tooltipTitle: t(
                      "api_details_section.agreements_tooltip.title",
                    ),
                    tooltipContent: t(
                      "api_details_section.agreements_tooltip.content",
                    ),
                  }}
                />
              </li>
              <!-- Will be available soon when template will be deployed -->
              <!-- <hr class="my-0 border-2" />
              <li class="list-group-item border-0">
                <InformationContainer
                  label={t('api_details_section.risk_analysis_template_label NON DISPONIBILE')}
                  content={t('available')}
                  icon={{
                    iconName: 'it-info-circle',
                    tooltipTitle: t('api_details_section.risk_analysis_template_tooltip.title'),
                    tooltipContent: t('api_details_section.risk_analysis_template_tooltip.content'),
                  }}
                />
              </li> -->
            </ul>
          </div>

          <div class="mb-default">
            <h4 id="specifiche-tecniche" class="mb-4">
              {t("tech_specification_section.title")}
            </h4>
            <ul class="list-group bg-white mt-4 px-3">
              <li class="list-group-item border-0">
                <InformationContainer
                  label={t("tech_specification_section.current_version")}
                  content={eservice.active_descriptor?.version ?? "1"}
                />
              </li>
              <hr class="my-0 border-2" />
              <li class="list-group-item border-0">
                <InformationContainer
                  label={t("tech_specification_section.technology")}
                  content={eservice.technology === "Rest" ? "REST" : "SOAP"}
                />
              </li>
              <hr class="my-0 border-2" />
              <li class="list-group-item border-0">
                <InformationContainer
                  label={t("tech_specification_section.delivery_mode")}
                  content={eservice.mode === "Deliver"
                    ? t("tech_specification_section.delivery_mode.deliver")
                    : t("tech_specification_section.delivery_mode.receive")}
                />
              </li>
              <hr class="my-0 border-2" />
              <li class="list-group-item border-0">
                <InformationContainer
                  label={t("tech_specification_section.signal_hub")}
                  content={eservice.is_signal_hub_enabled
                    ? t("available")
                    : t("not_available")}
                  icon={{
                    iconSize: "sm",
                    iconName: "it-info-circle",
                    tooltipTitle: t("signalhub.tooltip.title"),
                    tooltipContent: t("signalhub.tooltip.content"),
                  }}
                />
              </li>
            </ul>
          </div>

          <div class="mb-default">
            <AttributeSection
              attributes={eservice.active_descriptor?.attributes ?? {
                certified: [],
                verified: [],
                declared: [],
              }}
            />
          </div>

          <div class="mb-default">
            <h4 id="documentazione" class="mb-4">
              {t("documentation_section.title")}
            </h4>

            <div class="row px-2 mx-0 bg-white py-2">
              <div class="col-xs-12 col-md-8">
                <span>{t("documentation_section.access_required")}</span>
              </div>
              <div
                class="col-xs-12 col-md-4 text-xs-start text-md-end mt-2 mt-lg-0"
              >
                <a
                  class="text-decoration-none"
                  data-mp-external-link-id={`${routeKey}_documentationSection_accessLink`}
                  data-mp-external-link-description="TODO"
                  href={links.interopPlatformLink}
                  target="_blank"
                  rel="noreferrer"
                >
                  {t("documentation_section.access_link")}
                  <BootstrapItaliaIcon
                    name="it-external-link"
                    color="primary"
                    size="sm"
                  />
                </a>
              </div>
            </div>
          </div>

          <div class="row bg-primary-c0 rounded-3 p-4 p-lg-5">
            <div class="col-xs-12 col-md-8">
              <h4>{t("implementation_section.title")}</h4>
            </div>
            <div
              class="col-xs-12 col-md-4 text-xs-start text-md-end mt-3 mt-lg-0"
            >
              <a
                class="btn btn-primary btn-icon"
                data-mp-external-link-id={`${routeKey}_documentationSection_authentication_link`}
                data-mp-external-link-description="TODO"
                href={links.interopPlatformLink}
                target="_blank"
                rel="noreferrer"
              >
                {t("implementation_section.authentication_link")}
                <BootstrapItaliaIcon
                  name="it-external-link"
                  color="white"
                  className={"ms-1"}
                />
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
