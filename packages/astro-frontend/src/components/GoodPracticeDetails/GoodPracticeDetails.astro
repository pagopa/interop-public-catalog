---
import { getLangFromUrl } from '../../i18n/utils.i18n'
import { useGoodPracticesTranslations } from '../../i18n/good-practices.i18n'
import { EServiceCard } from '../shared/EServiceCard'
import PageIndexNav from '../shared/PageIndexNav.astro'
import NoteTecniche from './NoteTecniche.astro'
import { match } from 'ts-pattern'
import { renderRichTextStrapiNodes } from '../../utils/rich-text-strapi-renderer'
import type { GoodPractice } from '../../server/models/good-practice.types'

interface Props {
  goodPracticeBody: GoodPractice['body']
}

const { goodPracticeBody } = Astro.props

const currentLocale = getLangFromUrl(Astro.url.pathname)
const tGoodPractices = useGoodPracticesTranslations(currentLocale)

const HEADING_CLASS = 'h4 mb-3'
const PARAGRAPH_CLASS = 'mb-4'

const sectionTitles = goodPracticeBody
  .filter((s) => s.__component === 'buona-pratica.title')
  .map((s) => ({ label: s.Text, id: s.id.toString() }))
---

<div class="row">
  <div class="d-none d-md-block col-3">
    <PageIndexNav
      title="Indice della pagina"
      headings={[
        ...sectionTitles,
        { label: tGoodPractices('details.section.apis.heading'), id: 'api-utilizzate' },
      ]}
      style="top: 1rem;"
      class="position-sticky"
    />
  </div>
  <div class="col-12 col-md-9">
    <article>
      {
        goodPracticeBody.map((c) =>
          match(c)
            .with({ __component: 'buona-pratica.image' }, (c) => (
              <figure
                style="background-color: #f2f2f2;"
                class="d-flex align-items-center flex-column py-3 mb-4"
              >
                <img
                  src={c.image.url}
                  alt={c.image.alternativeText}
                  width={c.image.width}
                  height={c.image.height}
                  class="my-3 mx-auto max-h-60"
                />
                <figcaption class="text-center">{c.caption}</figcaption>
              </figure>
            ))
            .with({ __component: 'buona-pratica.title' }, (c) => (
              <h2 id={c.id.toString()} class={HEADING_CLASS}>
                {c.Text}
              </h2>
            ))
            .with({ __component: 'buona-pratica.description' }, (c) => (
              <p class={PARAGRAPH_CLASS} set:html={renderRichTextStrapiNodes(c.Text)} />
            ))
            .with({ __component: 'buona-pratica.esempio-concreto' }, (c) => (
              <div class="bg-primary-c0 p-4 mb-4">
                <Fragment set:html={renderRichTextStrapiNodes(c.example)} />
              </div>
            ))
            .with({ __component: 'buona-pratica.nota-tecnica' }, (c) => (
              <NoteTecniche class="mb-4 mt-5" content={c.example} />
            ))
            .exhaustive()
        )
      }

      <h2 id="api-utilizzate" class="h4 mb-4">
        {tGoodPractices('details.section.apis.heading')}
      </h2>
      <div class="row g-4">
        <div class="col-12 col-md-6">
          <EServiceCard
            currentLocale={currentLocale}
            name="Consultazione Attestazione ISEE"
            description="Servizio di consultazione Attestazione ISEE"
            producerName="Istituto Nazionale Previdenza Sociale - INPS"
            isOpenData
          />
        </div>
        <div class="col-12 col-md-6">
          <EServiceCard
            currentLocale={currentLocale}
            name="C020-servizioAccertamentoResidenza"
            description="C020-servizio di Accertamento Residenza"
            producerName="Ministero dell’Interno"
          />
        </div>
        <div class="col-12 col-md-6">
          <EServiceCard
            currentLocale={currentLocale}
            name="C021-servizioAccertamentoStatoFamiglia"
            description="C021-servizio Accertamento Stato Famiglia"
            producerName="Ministero dell’Interno"
          />
        </div>
      </div>

      <div class="mt-4 text-secondary pt-4">
        <em>{tGoodPractices('details.lastUpdate')}</em>
      </div>
    </article>
  </div>
</div>
